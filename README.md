# dotfiles

## Developer maintenance

This repository includes a scoped pre-commit workflow and helper scripts to keep things tidy and fast.

- Scoped pre-commit config: `dot-config/zsh/zsh-quickstart-kit/.pre-commit-config.yaml`
  - Scope: only checks files under `dot-config/zsh`, `tools`, and `tests`.
- Heavy tests gating:
  - Local commits skip the zsh kit’s heavy unit/integration/security tests and quick perf run by default.
  - Set `ZSH_KIT_RUN_FULL_TESTS=1` (or run in CI) to enable them during pre-commit.

### Makefile targets

Use these convenience targets from the repo root:

- `make precommit-install` — Install pre-commit hooks locally.
- `make precommit-run` — Run scoped pre-commit checks over all files.
- `make precommit-normalize` — Normalize executable bits to match shebangs, ensure newline at EOF, then run the scoped checks.
- `make broken-symlinks-list` — List all broken symlinks in the repository.
- `make broken-symlinks-remove` — Remove all broken symlinks that are tracked by git.
- `make perf-update` — Run N=5 fast-harness capture and update variance/governance/perf badges.
- `make fmt` — Alias for `precommit-normalize`.
- `make check` — Alias for `precommit-run`.

### Maintenance script

- `tools/maintenance/normalize-exec-bits.sh`
  - Adds `+x` to files that begin with `#!` (shebang) and removes `+x` from files that don’t.
  - Updates both the working tree and the git index so pre-commit shebang checks pass consistently.
  - Example:
    - `tools/maintenance/normalize-exec-bits.sh` (default scope: `dot-config/zsh`, `tools`, `tests`)
    - `tools/maintenance/normalize-exec-bits.sh --dry-run` (preview only)

### Notes

- CLI plugin directories (e.g., Docker) are ignored via `.gitignore` pattern: `**/cli-plugins/`
- To run pre-commit manually with the scoped config:
  - `pre-commit run --all-files -c dot-config/zsh/zsh-quickstart-kit/.pre-commit-config.yaml`

Compliant with [/Users/s-a-c/dotfiles/dot-config/ai/guidelines.md](/Users/s-a-c/dotfiles/dot-config/ai/guidelines.md) v50b6b88e7dea25311b5e28879c90b857ba9f1c4b0bc974a72f6b14bc68d54f49

Personal dotfiles managed (or migrating toward) GNU Stow for symlink-based configuration management.

### ZSH Performance & Badge Refresh

For ZSH configuration performance monitoring and badge updates:

- **Automated**: Badges are refreshed nightly via CI workflow
- **Manual refresh**: `make perf-update` (runs N=5 capture and updates all badges)
- **Direct script**: `cd dot-config/zsh && ZDOTDIR=$(pwd) tools/update-variance-and-badges.zsh`

If badges look stale, use the manual refresh command above. The variance guard is currently active with streak 3/3, maintaining performance stability monitoring.

## Status Badges
(Generated by CI; JSON shield specs live under docs/badges/)

- Hooks: ![hooks status](https://s-a-c.github.io/dotfiles/badges/hooks.svg)
- Infra Health: ![infra health](https://s-a-c.github.io/dotfiles/badges/infra-health.svg)
  - Placeholder until infra-health badge generation script synthesizes perf + structure + hooks (planned).
  - Expected future states: green (all good), yellow (degradation), red (critical failure).
- Performance: ![performance](https://s-a-c.github.io/dotfiles/badges/perf.svg)
- Structure: ![structure](https://s-a-c.github.io/dotfiles/badges/structure.svg)
- Security: ![security](https://s-a-c.github.io/dotfiles/badges/security.svg)

## ZSH Redesign – Stage Dashboard
| Stage | Name | Status | Tag | Key Metrics / Notes |
|-------|------|--------|-----|---------------------|
| 1 | Foundation | ✅ | refactor-stage1-complete | Structure + perf scaffolding established |
| 2 | Pre-Plugin Migration | ✅ | refactor-stage2-preplugin | Pre-plugin baseline: mean=35ms stdev=11ms (N=5) |
| 3 | Post-Plugin Core | ⏳ | (pending) | Planning security-integrity, interactive opts, core functions |
| 4–5 | Feature / UI & Async | (future) | — | Plugins, async scheduling, completion gating |
| 6–7 | Promotion / Archive | (future) | — | Promotion guard, archival policy |

Stage 2 complete: pre-plugin modules (00–30) finalized; baseline locked; pre-plugin regression guard tightened to +7% (target +5% after additional low-variance sample sets). Stage 3 will add security/option core, helper namespace (`zf::`), and verify/apply PATH append fix.


## Contents
- Consolidated `.gitignore` tuned for multi-language/editor noise and secret/material exclusion
- Automated secret scanning GitHub Action (`.github/workflows/secret-scan.yml`)
- Local pre-commit secret scan hook (`.githooks/pre-commit.d/secret-scan`)
- History rewrite plan (`SECRET_HISTORY_REWRITE_PLAN.md`)
- Gitleaks baseline configuration (`.github/gitleaks.toml`)

## Secret Management & Scanning

### 1. Preventive Ignore Rules
Any directory named `.env` (and common secret file extensions) are ignored:
```
.env
.env.*
*.env
.env/
```
Plus explicit ignore for `dot-config/zsh/.env/` and typical key/cert/state files (e.g. `*.pem`, `terraform.tfstate*`, `*.tfvars`).

### 2. CI Secret Scanning (`secretScan` workflow)
Runs on:
- Pull Requests (opened, synchronize, reopen, ready_for_review)
- Pushes to `main` / `master`
- Manual dispatch

Uses `gitleaks` with baseline config at `.github/gitleaks.toml`.
Failure blocks merges when potential secrets are detected.

Adjust sensitivity by editing `.github/gitleaks.toml`; add narrow allowlist patterns instead of broad file/path wildcards to minimize false negatives.

### 3. Local Pre-Commit Hook
Path: `.githooks/pre-commit.d/secret-scan`

Enables fast feedback before pushing:
```
git config core.hooksPath .githooks
```

Optional environment variables:
- `SECRET_SCAN_VERBOSE=1` for debug
- `SECRET_SCAN_MAX_FINDINGS=20` to raise limit
- `SECRET_SCAN_ALLOW_REGEXES='EXAMPLE,DUMMY'` comma-separated suppression
- `SECRET_SCAN_DISABLE_GITLEAKS=1` to force fallback heuristic scanner
- `SKIP_SECRET_SCAN=1` (discouraged) bypasses the hook

### 4. Manual Local Scan Examples
Full repo scan (HEAD):
```
gitleaks detect --redact --config .github/gitleaks.toml
```
Diff-only (against main):
```
git fetch origin main
gitleaks detect --redact --config .github/gitleaks.toml --log-opts="origin/main..HEAD"
```

### 5. History Rewrite (If Secrets Entered History)
Follow `SECRET_HISTORY_REWRITE_PLAN.md` for a surgical rewrite using:
```
git filter-repo --force --invert-paths \
  --path dot-config/zsh/.env/api-keys.env \
  --path dot-config/zsh/.env/development.env \
  --path dot-config/zsh/.env/
```
Then:
```
git push --force-with-lease origin main
```
And instruct collaborators to reset:
```
git fetch origin
git checkout main
git reset --hard origin/main
git clean -fd
```

### 6. Redaction (Optional)
Populate `replacements.txt` with literal or `regex:` patterns and run:
```
git filter-repo --force --replace-text replacements.txt
```
Prefer deletion over redaction for environment files unless historical retention is required.

## Development Workflow Notes
1. Create/edit configs under `dot-config/`
2. Stow (example):
   ```
   stow --target=$HOME zsh
   ```
3. Commit changes (hook scans automatically)
4. Push; GitHub Action enforces secondary scan

## Extending Scanning
Potential future enhancements:
- SARIF upload for GitHub Advanced Security
- Adding entropy threshold tuning in baseline config
- Language-specific rule additions (e.g., Terraform provider creds)

## Contributing
Changes should preserve:
- Principle of least privilege in CI
- Minimal false positive surface (tight allowlists)
- Clear audit trails in rewrite/secret-related docs

## License
See `LICENSE` (if present).

## Quick Reference Commands
Rotate & rewrite:
```
git clone --mirror <url> mirror.git
pip install git-filter-repo
git filter-repo --force --invert-paths --path dot-config/zsh/.env/
git push --force-with-lease origin main
```

Validate purge:
```
git grep -F 'API_KEY=' || echo 'Not found'
git log -- dot-config/zsh/.env/ | head -1 || echo 'Directory removed'
```

## Acknowledgements
Security automation aligns with documented security standards (authentication, logging, incident response) in the guidelines referenced above.
