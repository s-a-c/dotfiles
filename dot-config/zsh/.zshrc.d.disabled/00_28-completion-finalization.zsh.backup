#!/usr/bin/env zsh
# Safe completion initialization - prevents multiple compinit calls
# This replaces the problematic completion setup

# Prevent multiple initializations
if [[ -n "${_COMPINIT_INITIALIZED:-}" ]]; then
    return 0
fi

# Use shared compdump file
local compdump="$ZSH_CACHE_DIR/.zcompdump"
mkdir -p "$(dirname "$compdump")"

# Initialize completion system once
autoload -Uz compinit
if [[ -f "$compdump" && "$compdump" -nt ~/.zshrc ]]; then
    # Use existing dump if newer than .zshrc
    compinit -C -d "$compdump" >/dev/null 2>&1
else
    # Rebuild completion dump
    compinit -d "$compdump" >/dev/null 2>&1
fi

# Mark as initialized
export _COMPINIT_INITIALIZED=1
