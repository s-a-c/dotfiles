#!/usr/bin/env bash
# pre-commit - lightweight lint gate for ZSH config
# - Redirection spacing guard (numeric file creation prevention)
# - Optional shellcheck on newly added/modified shell fragments

set -euo pipefail

ROOT_DIR="$(git rev-parse --show-toplevel)"
cd "$ROOT_DIR" || exit 1

printf '[pre-commit] starting checks\n' >&2

# Refuse newly added files/dirs whose basename is purely digits (catches accidental redirection files)
bad=$(git diff --cached --name-only --diff-filter=A | awk -F/ '{print $NF}' | grep -E '^[0-9]+$' || true)
if [ -n "$bad" ]; then
  printf '%s\n' "Pre-commit failed: refusing to add numeric-only path(s):" "$bad" >&2
  exit 1
fi
# ...existing code...

# Collect staged shell-ish files (zsh, sh) excluding vendor/third-party caches
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(zsh|sh)$' || true)
if [[ -z "$STAGED_FILES" ]]; then
  printf '[pre-commit] no shell fragments staged\n' >&2
  exit 0
fi

# 1. Redirection lint (spacing patterns like "> 2")
LINT_SCRIPT="tools/lint-redirections.zsh"
if [[ -x "$LINT_SCRIPT" || -f "$LINT_SCRIPT" ]]; then
  # Run in self-test skip mode if environment variable set
  zsh "$LINT_SCRIPT" --quick 1>/dev/null || {
    printf '\n[pre-commit] redirection lint failed. Inspect output above.\n' >&2
    exit 1
  }
  printf '[pre-commit] redirection spacing lint passed\n' >&2
else
  printf '[pre-commit] redirection lint script not found (%s)\n' "$LINT_SCRIPT" >&2
fi

# 2. Optional shellcheck
if command -v shellcheck >/dev/null 2>&1; then
  printf '[pre-commit] running shellcheck\n' >&2
  FAIL=0
  while IFS= read -r f; do
    # Skip archived or vendor paths
    if [[ "$f" == *".ARCHIVE/"* ]]; then continue; fi
    shellcheck -x "$f" || FAIL=1
  done <<< "$STAGED_FILES"
  if (( FAIL )); then
    printf '\n[pre-commit] shellcheck reported issues\n' >&2
    exit 1
  fi
  printf '[pre-commit] shellcheck clean\n' >&2
else
  printf '[pre-commit] shellcheck not installed (skipping)\n' >&2
fi

printf '[pre-commit] all checks passed\n' >&2
exit 0
